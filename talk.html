
<!DOCTYPE html>
<html>
  <head>
    <title>My Awesome Presentation</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <style type="text/css">
      @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);
      body { font-family: 'Droid Serif'; }
      h1, h2, h3 {
        font-family: 'Yanone Kaffeesatz';
        font-weight: normal;
      }
      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }
    </style>
  </head>
  <body>
    <textarea id="source">

class: center, middle

## Global shipping of _on-demand_ products in **Solidus**

???

Introduction: I'm Alex, backend developer at Lostmy.name, where I have been
working for the past _almost_ 3 years.

_short pause_

Today I'll be going through some of the fun, and experimentation, we had with
Solidus trying to set it up for our
particular use case:

**delivering magical, personalised products to our customers
all around the globe.**

_pause_


---

class: center, middle

<img src="img/logo.svg" width="400px"> </img>
<br>
<img src="img/solidus.png"> </img>

???

I have worked with (Spree) ... Solidus for the same amount of time as I have been at Lostmy.name.
We have quite a specific set of requirements and we are constantly pushing
Solidus to do more things!

---

class: center

<img src="img/products.jpg" width="100%"> </img>


---

class: center, middle

<img src="img/algo.jpg" width="600px"> </img>

???

When we started we were 3 engineers and neither of us had very much e-commerce
experience, so being able to have a base project to work from made a big difference.

_The tshirts are a running joke of when our CEO was on TV and was asked how our
books are created and said that: "we have a bespoke algorithm"._

We had a previous website, that had very basic concepts of ecommerce: `Order`
`Book` `Payment`. Then we moved to solidus.

Basically looked like this. Switch slides now.

---

class: center, middle

<img src="img/tricycle.jpg" width="600px"> </img>

???

It can go places, but it's pretty damn slow, not very weather proof, and
you can't make a lot of enhacements. So we went to solidus.

---

class: center, middle

<img src="img/cockpit.jpg" width="600px"> </img>

???

Going from that... to this ........ it was quite a change.

---

class: center
# Enter Solidus

<img src="img/erd.png" height="500px"> </img>

???

We went from a simple website to a very intricate, feature-rich e-commerce
engine. We had **no idea** what we subscribed to!! We obviously wanted a system
that would scale, but going from 4 models to two dozen was a **very** big chance.

We were not ready to start thinking about `line items` `inventory units`
`shipping rates` `stock items`. We wanted to sell **personalised** childrens books.

Sure, it shouldn't have to be that hard??


---

class: center, middle

### _Personalized_ content

???

We started at our basic need - to be able to have customisable products,
and sell them.

We thought - "OK, this is a big project; someone probably done
this before, right?"
So we started to look for _solidus_ extensions that would allow us to customise
a product.

_ I have to say at this point we still didn't fully understand what
**product options** and **variants** fully were, and how to use them._

---

class: center, middle

### OK - We have to write our own

???

After a few days of looking around and tying a few extenions, we decided,
that _unfortunately_, we have to write our own **product customisation**
code.

---
class: center, middle

### Sure, no problem

---
class: center, middle

### But what do we actually write?

???

Ok - it's a new model! Great!!
But where does it fit in the puzzle?
What values will it contain?

_Important to specify that at this point we only had an `enGB` softback book
available for boy/girl.
We knew we gonna do a hardback book and more languages; as well as other products
but not a lot more than that._

---
class: center, middle

### We really need to understand what these variants are

???

So we create a new product **Lostmy.name book**.

Now what should the variants be?

#### Anyone want to guess?

The product will have the product options of `gender` and `locale`. At this we
don't have a product option for the `cover_type` (softback vs hardback) - because
we were not that forward thinking _ loads of regrets about this_.

---
class: center, middle

### `lmn:softback:boy:en-GB`
### `lmn:softback:girl:en-GB`.

???

Notice how we added _softback_ in there, although we don't actually model that
in the product option? ...

Yep - that was problematic.

---
class: center, middle

### `Spree::Customisation`

???

So we have variants, and line items. Line items felt like the right place for
attaching the customisation. They are created when someone adds something to
the cart, so it's perfect.

_ We also evaluated attaching the customisation to `InventoryUnit` - but
those generated and regenerated at basically every step of the checkout stage._

---
class: center, middle

### Reminder: We were on Spree 2.0

???

Yep. Things are a lot better in terms of how objects are generated and used today
compared to back then. (about 3 years ago!).

---
class: center, middle

picture


LineItem <--> Variant
|--> Customisation

???

At this point, we had a place to store our customisation options, ie: name,
dedication.

---
class: center, middle

### Decorators

???

At this point:

- we have a model
- we have a link to an existing Spree model

We need to create a new route, put together a controller and a view to add a new
Lostmy.name book to the cart.

---
class: center, middle

### Book in cart!

???

We got to this point - it felt great; but also very overwhelming. We were using
Spree, but we had **a lot**, and I mean **A LOT** of decorators.
Now that we have something in the cart, surely, it should be easy to checkout,
as we didn't change any of that logic? ... right? right?

From the cart - we only had to tweak the generation of inventory units - as our
items were unique to properties that were not determined by the variant. Lets
not talk too much about this now - as it's a whole other list of surprises.

Now enter the 2nd complication of our business: multiple stock locations.

---
class: center, middle

### Stock (Inventory)

???

We operate an on-demand business, but we still have some _stock_ on the premises
of our stock locations. When we launched with 1 book it was an easy problem to
solve. But now we have over 90 variants, that have different availabilities
throughout the world.

As we are adding more products we have to start to **really** manange the
inventory in solidus.

Thankfully, here we were able to use the solution from Spree, which is the
StockItems table and view.

It looks like this now.

---
class: center, middle

## Picture of our stock item admin view

???

although we **still** don't know why we have negative counts. but this works,
and we have no reason to change it!

---
class: center, middle

### Stock Locations

???

Again, we were able to use this concept from Solidus. We added some additional
fields to be able to cope with our shop's specific requests such as: daily
capacity, working days, holiday calendar, etc.

---
class: center, middle

### Shipping Methods

???

Here we had to tweak a lot. Originally, in _Spree 2.0_ the shipping method
has no connection to the stock location; but only a connection to the zone
(the destination).

Initially we worked around this limitation; by modelling around this limitation.

Then we had to add some complications based on the contents of the package.

Then we added another `stock location`, and things started breaking down. This
is where, this series of commits started.

---

class: center, middle

<img src="img/commits.png" width="1000px"> </img>

???

dark days.

---

class: center, middle

### Coordinator

Builder,Priotizer, Estimator, Validator

---
class: center, middle

### OK - more decorations

---
class: center, middle

### How do we prioritize?

Better write some custom code now. It will definitely resist over time.

???

Of course - we now have 2 stock locations - which makes this logic very easy.
If it's in the US, then use A; otherwise use B.

Lets see some code, _I_ wrote, about 3 years ago.


---
class: middle

```
def sort_packages
  # If it's the US make sure to select the package from riverside
  # If it's not the US make sure to select the package from charlesworth
  if order.ship_address.country.iso == "US"
    stock_location_id = Spree::StockLocation.friendly.find("riverside").id
    selected_package = packages.select { |p| p.stock_location.id == stock_location_id }
    selected_package = selected_package.first
    packages.unshift(selected_package)
  else
    ...
  end
end
```

---
class: middle

```
adjuster = @adjuster_class.new(line_item.variant, line_item.quantity, :on_hand)

# Make sure we pass the line item so that we can validate that it's the right
# item we are picking!
# Important for us since the customisation is not reflected in the variant
visit_packages(adjuster,line_item)

adjuster.status = :backordered
visit_packages(adjuster,line_item)

```

---

class: center, middle

### Wait - we don't want split shipments


---











```

files.each do |file|
  puts file
end
```

# Agenda

1. Introduction
2. Deep-dive
3. ...

[NOTE]: Note that you need remark.js alongside this html file, but no internet connection.
---

# Introduction

    </textarea>
    <script src="https://remarkjs.com/downloads/remark-latest.min.js" type="text/javascript">
    </script>
    <script type="text/javascript">
      var slideshow = remark.create({
        highlightLanguage: 'ruby',
        ratio: '16:9',
        highlightStyle: 'solarized-dark',
      });
    </script>
  </body>
</html>
